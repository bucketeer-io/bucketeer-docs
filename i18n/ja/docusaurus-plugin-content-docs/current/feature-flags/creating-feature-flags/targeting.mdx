---
title: フィーチャーフラグによるターゲティング
# sidebar_position:
slug: /feature-flags/creating-feature-flags/targeting
description: Explain the targeting process and presents how to configure the feature flag targeting. The page will describe the fields and show an example.
tags: ['create', 'guide', 'feature-flag']
---

import CenteredImg from '@site/src/components/centered-img/CenteredImg';

Bucketeerのターゲティングタブでは、各バリエーションのフラグが表示されるユーザーまたはターゲットを定義できます。この強力な機能により、内部テスト、プライベートベータ、ユーザビリティテストなどの特定の目的のために、より広範なリリースの前に機能をロールアウトすることができます。いくつかの例を見てみましょう。

:::info ターゲットとは

ターゲティングタブは_ユーザー_を指しますが、ユーザーはターゲットに一意に対応する識別子を表すことができることに注意することが重要です。アプリケーションのユーザー、メールアドレス、システム、サービス、マシン、リソース、または一意に識別できる他のエンティティをターゲットにすることができます。

:::

Bucketeerダッシュボードのターゲティングページにアクセスするには、**フィーチャーフラグ**タブにアクセスし、目的のフラグを選択して名前をクリックします。そのフラグの**ターゲティング**ページにリダイレクトされます。

## ターゲティングページ

**ターゲティング**ページでは、フラグの動作をカスタマイズおよび制御するためのさまざまなオプションがあります：

- **スイッチボタン**: スイッチボタンを使用して、フィーチャーフラグのターゲティング構成を有効または無効にします。これにより、定義したターゲティングルールをアクティブ化または非アクティブ化できます。

- [**前提条件**](/feature-flags/creating-feature-flags/targeting#prerequisites): 前提条件の設定を行い、フラグの条件を指定します。前提条件を使用すると、フラグ間の依存関係を確立できます。

- [**ターゲティング**](/feature-flags/creating-feature-flags/targeting#targeting): フラグの各バリエーションのターゲットを定義します。ターゲットの例としては、Android、iOS、Webなどの特定のシステムが挙げられます。

- [**ルールロールアウトパーセンテージ**](/feature-flags/creating-feature-flags/targeting#rollout-percentage): 機能のロールアウトに伴うリスクを管理するには、機能を徐々に、コンテキストの割合に応じてロールアウトします。最初は小規模な範囲で開始し、機能の安定性と有効性への確信が高まるにつれて範囲を拡大します。これにより、ロールアウト中に発生する可能性のある潜在的な問題を軽減できます。

- **デフォルト戦略**: フラグのデフォルトバリエーションを定義します。このバリエーションは、特定のターゲティングルールまたは前提条件が満たされない場合に提供されます。

- **OFFバリエーション**: フラグがOFFの時に返されるバリエーションを指定します。

以下の画像は、**ターゲティング**ページの例です。

<CenteredImg
  imgURL="img/feature-flags/targeting/targeting-page.png"
  alt="targeting page panel"
/>

## ターゲティングの仕組み

ターゲティングページでは、ユーザーがどのフラグバリエーションを受け取るかを定義する一連の条件を定義できます。ターゲティングオプションが複数提供されているため、エバリュエーションの順序を理解しておく必要があります。そうしなければ、ターゲティング戦略が目的を反映しない可能性があります。理解を深めるために、以下にエバリュエーションの順序と、考えられる結果に関連する説明を示します。

1. **スイッチボタン**: スイッチが OFF の位置にある場合、ユーザーは OFF バリエーションを受け取り、それ以上のエバリュエーションは必要ありません。それ以外の場合は、エバリュエーションは前提条件が存在するかどうかをチェックします。

2. [**前提条件**](/feature-flags/creating-feature-flags/targeting#prerequisites): 前提条件フラグがすべて存在する場合、それらを評価します。すべてのフラグが選択されたバリエーションを返し、すべての条件を満たしている場合、エバリュエーションはターゲティングまたはロールアウトパーセンテージによって定義された次のステージに進みます。いずれかの前提条件が失敗し、指定されたバリエーションとは異なるバリエーションを返した場合、ユーザーはOFFバリエーションを受け取り、それ以上のエバリュエーションは必要ありません。

3. [**ターゲティング**](/feature-flags/creating-feature-flags/targeting#targeting): 前提条件が満たされた後、ターゲットが評価されます。各ユーザーまたはユーザーグループは、定義したバリエーションを受け取ります。ユーザー/ユーザーグループがどのバリエーションにもリストされていない場合は、ロールアウトルールが評価されます（少なくとも1つ存在する場合）。存在しない場合は、ユーザーはデフォルトの戦略バリエーションを受け取ります。

4. [**ルールロールアウトパーセンテージ**](/feature-flags/creating-feature-flags/targeting#rollout-percentage): ルールが満たされない場合、ユーザーはデフォルトの戦略バリエーションを受け取ります。

Bucketeerでのターゲティングの仕組みをまとめたフローチャートは以下の通りです。

<CenteredImg
  imgURL="img/feature-flags/targeting/targeting-fluxogram-2.svg"
  alt="targeting fluxogram panel"
  wSize="600px"
/>

### 前提条件

前提条件フラグがターゲティングに追加されると、現在のフラグは、前提条件フラグの返された値が設定された値と一致する場合にのみ評価されます。つまり、前提条件が満たされている場合にのみ、ターゲットフラグが評価されます。

複数のフラグが前提条件として設定されている場合、論理演算子ANDを使用して評価されます。これにより、ターゲットフラグを評価する前に、すべての前提条件が満たされていることを確認します。前提条件フラグのいずれかからの戻り値が期待どおりの値でない場合、ターゲットフラグのOFFバリエーションが返されます。OFFバリエーションは、前提条件が満たされていない場合のフォールバックオプションとして機能します。

以下の画像は、2つのフラグを前提条件として使用した例です。したがって、ターゲットまたはロールアウトルールの評価は、最初のフラグが**true**のバリエーションを返し、2番目のフラグが**a**のバリエーションを返す場合にのみ行われます。それ以外の場合は、BucketeerはOFFバリエーションを提供します。

<CenteredImg
  imgURL="img/feature-flags/targeting/prerequisites.png"
  alt="prerequisites example"
  wSize="500px"
/>

### ターゲティング

Bucketeerのターゲティングセクションでは、各フィーチャーフラグバリエーションを受け取るユーザーまたはグループを定義できます。ブール型フラグを例に取ると、以下の画像のように、Androidユーザーにはtrueバリエーションを、iOSユーザーにはfalseバリエーションを提供できます。

<CenteredImg
  imgURL="img/feature-flags/targeting/targeting-boolean-example.png"
  alt="targeting boolean example panel"
  wSize="500px"
/>

上記の画像の例では、使用できるバリエーションが2つあります。ただし、ブール以外のフラグの種類を使用する場合は、より多くのバリエーションを追加できます。定義したすべてのバリエーションは、ターゲティングセクション内でアクセスできるようになります。

4つのバリエーションのある文字列フラグに関する実際の例を考えてみましょう： **value-1**、**value-2**、**value-3**、**value-4**です。この例では、各バリエーションは特定のプラットフォームに関連付けられています。つまり、Androidユーザーは**value-1**を受け取り、Webユーザーは**value-2**を受け取り、iOSユーザーは**value-3**を受け取り、他のプラットフォームのユーザーは**value-4**バリエーションを受け取ります。この例の構成は以下の画像に示されています。

<CenteredImg
  imgURL="img/feature-flags/targeting/targeting-string-example.png"
  alt="create feature flag panel"
  wSize="500px"
/>

## ロールアウトパーセンテージ

ロールアウトパーセンテージを使用すると、ユーザーを評価するためのルールを定義できます。ルールが満たされると、ユーザーは定義したバリエーションを受け取る、またはパーセンテージ分布を使用してどのバリエーションを返すかを決定できます。ルールは、次の条件を使用して、1つまたは複数の条件に基づいて作成できます。

- ユーザー属性。
- ユーザーセグメント。
- 日付。

### ユーザー属性

ロールアウトパーセンテージのルールで使用されるユーザー属性は、エンドユーザー属性を指します。これらの属性は、クライアント側でSDKを初期化するときに定義できます。動的属性を使用している場合は、`updateUserAttributes` 関数を使用します。属性の設定の詳細については、 [SDK](/sdk) コンテンツをご参照ください。以下のコードブロックは、JavaScriptを使用してSDKを初期化する際のエンドユーザー属性構成の例です。

```js showLineNumbers
const attributes = {
  app_version: '1.0.0',
  os_version: '11.0.0',
  device_model: 'pixel-5',
  language: 'english',
  genre: 'female',
};

const user = defineBKTUser({
  id: 'USER_ID',
  attributes: attributes,
});

await initializeBKTClient(config, user);
```

SDKがサーバーにリクエストを行う際、Bucketeerシステムは上記のすべての属性にアクセスして、ターゲティングエバリュエーションを実行します。

エンドユーザーの属性に基づいてロールアウトルールを使用するには、**ルールの追加**ボタンをクリックした後に**比較**オプションを選択します。その後、既存のエンドユーザー属性を使用して比較し、さまざまなバリエーションを割り当てることができます。

上記のコードブロックに記載されている属性を使用してユーザーを作成したと仮定します。 app_version = 1.0.0`かつ`language = english`のユーザーには、**value-1**バリエーションを提供したいと考えています。一方、`app_version = 2.0.0`のユーザーには、パーセンテージ分布を使用してすべてのバリエーションを提供したいと考えています。この場合、10%は**value-1**、20%は**value-2**、30%は**value-3**、40%は**value-4**のバリエーションを受け取ることになります。このようなターゲティングルールは、Bucketeerダッシュボードで以下の画像のように定義することができます。

<CenteredImg
  imgURL="img/feature-flags/targeting/rollout-user-atributes.png"
  alt="rollout rule definition based on attributes"
  wSize="500px"
/>

:::info ロールアウトパーセンテージ
パーセンテージ配分に基づくロールアウトパーセンテージを使用する場合、合計は常に100%になる必要があります。
:::

ユーザーがこれらのルールのいずれかを満たしていない場合、そのユーザーはデフォルトのバリエーションを受け取ることになります。

### ユーザーセグメント

ユーザーセグメントは、ユーザーの一意の`id`に基づいてダッシュボード内で定義できる特定のユーザーグループを指します。各ユーザーの`id`は、defineBKTUser関数を使用してユーザーを作成するときに確立されます。ユーザーをセグメントに関連付けるには、ダッシュボード内で手動で割り当てるか、.txtまたは.csvファイルをアップロードすることができます。これらのセグメントは、メールの種類、性別、場所など、さまざまな基準に基づいて作成できます。セグメントを作成することで、テスト用にユーザーを正確にターゲットおよびグループ化できます。以下の画像は、要求するユーザーが**テストユーザー**セグメントに属している場合に**value-1**バリエーションが返されるロールアウトルールを示しています。


<CenteredImg
  imgURL="img/feature-flags/targeting/rollout-rule-segment.png"
  alt="rollout rule definition based on segment"
  wSize="500px"
/>

### 日付

日付に基づいてロールアウトルールを定義することも可能です。特定の日付と目的のバリエーションまたはバリエーション分布を選択するとともに、目的の動作が指定された日付の前か後に発生することを期待するかどうかを示す必要があります。以下の例は、SDKリクエストが**2023-08-16 18:02**より前に作成された場合、ユーザーに**value-2**バリエーションが提供されるロールアウトルールを示しています。

<CenteredImg
  imgURL="img/feature-flags/targeting/rollout-rule-date.png"
  alt="rollout rule definition based on date"
  wSize="500px"
/>

:::info 条件の組み合わせ
ここでは1種類の条件のみを使用した例を示していますが、ユーザー属性、ユーザーセグメント、およびシステム上の日付条件を組み合わせることで、ロールアウトルールのターゲティングを向上させることが可能になります。
:::
